{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block title %}Cat?logo de Sahumerios - Fuego de Atenea{% endblock %}

{% block styles %}
<style>
:root {
    --bg-dark: #0f172a;
    --bg-card: #1e293b;
    --bg-card-hover: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-muted: #94a3b8;
    --accent-primary: #10b981;
    --accent-secondary: #f59e0b;
    --accent-danger: #ef4444;
    --accent-info: #8b5cf6;
    --border-color: #334155;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.4);
}

body {
    background: var(--bg-dark);
    color: var(--text-primary);
    min-height: 100vh;
}

/* Buttons */
.btn {
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    line-height: 1;
}

.btn-primary {
    background: linear-gradient(135deg, var(--accent-primary), #059669);
    color: #fff;
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #059669, var(--accent-primary));
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--bg-dark);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--bg-card-hover);
    border-color: var(--accent-primary);
    color: var(--accent-primary);
}

.btn-danger {
    background: var(--accent-danger);
    color: #fff;
    border: none;
}

.btn-danger:hover {
    background: #c53030;
    transform: translateY(-1px);
}

/* Header */
.catalog-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 0 20px;
}

.catalog-title {
    font-size: clamp(2rem, 5vw, 2.5rem);
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 16px;
}

.catalog-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
    margin-top: 32px;
}

/* Cards */
.product-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    box-shadow: var(--shadow);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.product-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-hover);
    border-color: var(--accent-primary);
}

.product-badges {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.badge-best-seller {
    background: linear-gradient(135deg, var(--accent-secondary), #d97706);
    color: #fff;
}

.badge-new {
    background: linear-gradient(135deg, var(--accent-primary), #059669);
    color: #fff;
}

.badge-import {
    background: linear-gradient(135deg, var(--accent-info), #7c3aed);
    color: #fff;
}

.product-image {
    position: relative;
    height: 250px;
    overflow: hidden;
    background: var(--bg-dark);
    display: flex;
    justify-content: center;
    align-items: center;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.4s ease;
    padding: 15px;
    box-sizing: border-box;
}

.product-card:hover .product-image img {
    transform: scale(1.05);
}

.product-actions {
    position: absolute;
    top: 12px;
    right: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    opacity: 0;
    transform: translateX(10px);
    transition: all 0.3s ease;
}

.product-card:hover .product-actions {
    opacity: 1;
    transform: translateX(0);
}

.action-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-card-hover);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: var(--accent-primary);
    color: #fff;
    transform: scale(1.1);
    border-color: var(--accent-primary);
}

.product-info {
    padding: 20px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.product-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 4px;
    line-height: 1.3;
}

.product-title a {
    color: inherit;
    text-decoration: none;
}

.product-title a:hover {
    color: var(--accent-primary);
}

.product-brand {
    font-size: 0.9rem;
    color: var(--accent-secondary);
    margin: 0 0 10px;
    font-weight: 600;
}

.product-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0 0 16px;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    display: box;
    line-clamp: 2;
    box-orient: vertical;
}

.product-price {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: auto;
    margin-bottom: 16px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
}

.current-price {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--accent-primary);
}

.old-price {
    font-size: 1rem;
    color: var(--text-muted);
    text-decoration: line-through;
}

.discount-badge {
    background: var(--accent-danger);
    color: #fff;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 700;
}

/* Quantity selector */
.quantity-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}

.qty-btn {
    width: 34px;
    height: 34px;
    border: 1px solid var(--border-color);
    background: var(--bg-dark);
    color: var(--text-primary);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
    font-size: 1.2rem;
    line-height: 1;
}

.qty-btn:hover {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: #fff;
}

.qty-input {
    width: 60px;
    padding: 8px 6px;
    border: 1px solid var(--border-color);
    background: var(--bg-dark);
    color: var(--text-primary);
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    -moz-appearance: textfield;
    appearance: none;
}

.qty-input::-webkit-outer-spin-button,
.qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.qty-input:focus {
    outline: none;
    border-color: var(--accent-primary);
}

/* Edit mode banner */
.edit-mode-banner {
    background: linear-gradient(135deg, var(--accent-secondary), #d97706);
    color: #fff;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 32px;
    box-shadow: var(--shadow-hover);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
}

.edit-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.edit-actions .btn {
    padding: 8px 14px;
    font-size: 0.9rem;
}

/* Header tweaks */
.topbar {
    background: var(--bg-card) !important;
    border-bottom: 1px solid var(--border-color);
}

.topbar nav a {
    color: var(--text-secondary) !important;
}

.topbar nav a:hover {
    color: var(--accent-primary) !important;
}

.btn-cart-toggle {
    color: var(--text-primary) !important;
}

.cart-dropdown {
    background: var(--bg-card) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-primary) !important;
}

/* Responsive */
@media (max-width: 600px) {
    .products-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .edit-mode-banner {
        flex-direction: column;
        align-items: flex-start;
    }

    .edit-actions {
        width: 100%;
        justify-content: space-between;
    }

    .edit-actions .btn {
        flex-grow: 1;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="catalog-header">
    <h1 class="catalog-title">Nuestra Colecci?n de Sahumerios</h1>
    <p class="catalog-subtitle">Descubre aromas ?nicos que transforman tu espacio. Calidad premium y esencias naturales.</p>
</div>

{% if edit_mode %}
<div class="edit-mode-banner">
    <div>
        <strong>? Modo edici?n activado</strong>
        <p style="margin: 4px 0 0; font-size: 0.9rem; opacity: 0.9;">Pod?s agregar, editar o eliminar productos del cat?logo.</p>
    </div>
    <div class="edit-actions">
        <a href="{% url 'sahumerios_lista' %}" class="btn btn-secondary">Salir de edici?n</a>
        <a href="{% url 'sahumerio_nuevo' %}" class="btn" style="background: #fff; color: #d97706;">+ Crear nuevo producto</a>
    </div>
</div>
{% endif %}

<div class="products-grid">
    {% for it in items %}
    {% with target_url=it.pk|default:it.idx %}
    <article class="product-card" data-product-id="{{ target_url }}" data-product-origin="{{ it.origen }}">
        {% if it.origen == 'DB' and it.pk %}
            {% url 'sahumerio_detalle' it.pk as detail_url %}
        {% elif it.match_id %}
            {% url 'sahumerio_detalle' it.match_id as detail_url %}
        {% else %}
            {% url 'excel_detalle' it.idx as detail_url %}
        {% endif %}

        <div class="product-badges">
            {% if forloop.counter <= 3 %}
            <span class="badge badge-best-seller">?? M?s vendido</span>
            {% endif %}

            {% if not it.match_id %}
                {% if it.origen != 'DB' or not it.pk %}
            <span class="badge badge-import">?? Importado</span>
                {% endif %}
            {% endif %}

            {% if forloop.counter|divisibleby:5 %}
            <span class="badge badge-new">? Nuevo</span>
            {% endif %}
        </div>

        <div class="product-image">
            <a href="{{ detail_url }}">
                {% with img_src=it.img_abs|default:it.img_file %}
                    {% if img_src %}
                        {% if it.img_file and not it.img_abs %}
                <img src="{% static 'img/productos/' %}{{ img_src }}" alt="{{ it.titulo }}" loading="lazy" decoding="async" width="800" height="800">
                        {% else %}
                <img src="{{ img_src }}" alt="{{ it.titulo }}" loading="lazy" decoding="async" width="800" height="800">
                        {% endif %}
                    {% else %}
                <img src="{% static 'img/placeholder.png' %}" alt="Sin imagen" loading="lazy" decoding="async" width="800" height="800">
                    {% endif %}
                {% endwith %}
            </a>

            <div class="product-actions" aria-hidden="true">
                <button class="action-btn" type="button" title="Vista r?pida">???</button>
                <button class="action-btn" type="button" title="Agregar a favoritos">??</button>
            </div>
        </div>

        <div class="product-info">
            <h3 class="product-title">
                <a href="{{ detail_url }}">
                    {{ it.titulo }}
                </a>
            </h3>

            {% if it.marca %}
            <p class="product-brand">Marca: {{ it.marca }}</p>
            {% endif %}

            {% if it.descripcion %}
            <p class="product-description">{{ it.descripcion }}</p>
            {% endif %}

            <div class="product-price">
                <span class="current-price">$ {{ it.precio|floatformat:2|intcomma }}</span>
                {% if forloop.counter|divisibleby:4 %}
                <span class="old-price">$ {{ it.precio|add:500|floatformat:2|intcomma }}</span>
                <span class="discount-badge">-15%</span>
                {% endif %}
            </div>

            {% if edit_mode %}
            <div class="edit-actions" style="margin: 5px 0 12px;">
                {% if it.origen == 'DB' and it.pk %}
                <a href="{% url 'sahumerio_editar' it.pk %}?volver={{ request.get_full_path|urlencode }}" class="btn btn-secondary">?? Editar</a>
                <form method="post" action="{% url 'sahumerio_borrar' it.pk %}" onsubmit="return confirm('?Est?s seguro de borrar este producto?')" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">??? Borrar</button>
                </form>
                {% else %}
                <a href="{% url 'sahumerio_nuevo' %}?sug_marca={{ it.marca|urlencode }}&sug_nombre={{ it.titulo|urlencode }}&sug_descripcion={{ it.descripcion|urlencode }}&sug_precio={{ it.precio|urlencode }}&sug_imagen_url={{ it.img_abs|urlencode }}&sug_imagen_file={{ it.img_file|urlencode }}" class="btn btn-primary">?? Crear en DB</a>
                {% endif %}
            </div>
            {% endif %}

            {% if it.origen == 'DB' and it.pk %}
                {% with item_id=it.pk %}
            <form action="{% url 'cart:add_db' item_id %}" method="post" class="cart-form" data-cart-form data-product-id="{{ item_id }}">
                {% csrf_token %}
                <input type="hidden" name="replace" value="0">
                <div class="quantity-selector">
                    <button type="button" class="qty-btn qty-minus">-</button>
                    <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                    <button type="button" class="qty-btn qty-plus">+</button>
                </div>
                <button type="submit" class="btn btn-primary add-to-cart-btn">?? Agregar al carrito</button>
            </form>
                {% endwith %}
            {% elif it.match_id %}
                {% with item_id=it.match_id %}
            <form action="{% url 'cart:add_db' item_id %}" method="post" class="cart-form" data-cart-form data-product-id="{{ item_id }}">
                {% csrf_token %}
                <input type="hidden" name="replace" value="0">
                <div class="quantity-selector">
                    <button type="button" class="qty-btn qty-minus">-</button>
                    <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                    <button type="button" class="qty-btn qty-plus">+</button>
                </div>
                <button type="submit" class="btn btn-primary add-to-cart-btn">?? Agregar al carrito</button>
            </form>
                {% endwith %}
            {% else %}
            <form action="{% url 'cart:add' %}" method="post" class="cart-form" data-cart-form>
                {% csrf_token %}
                <input type="hidden" name="origin" value="X">
                <input type="hidden" name="product_id" value="{{ it.idx }}">
                <input type="hidden" name="name" value="{{ it.titulo }}">
                <input type="hidden" name="price" value="{{ it.precio }}">
                <input type="hidden" name="img" value="{% if it.img_abs %}{{ it.img_abs }}{% elif it.img_file %}{% static 'img/productos/' %}{{ it.img_file }}{% else %}{% static 'img/placeholder.png' %}{% endif %}">
                <input type="hidden" name="replace" value="0">
                <div class="quantity-selector">
                    <button type="button" class="qty-btn qty-minus">-</button>
                    <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                    <button type="button" class="qty-btn qty-plus">+</button>
                </div>
                <button type="submit" class="btn btn-primary add-to-cart-btn" style="background: linear-gradient(135deg, var(--accent-secondary), #d97706); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
                    ?? Pedir importado
                </button>
            </form>
            {% endif %}
        </div>
    </article>
    {% endwith %}
    {% empty %}
    <p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">{% trans "No encontramos sahumerios para mostrar en este momento." %}</p>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const grid = document.querySelector('.products-grid');
    if (!grid) {
        return;
    }

    grid.addEventListener('click', function (event) {
        const minus = event.target.closest('.qty-minus');
        const plus = event.target.closest('.qty-plus');

        if (!minus && !plus) {
            return;
        }

        const form = event.target.closest('form');
        if (!form) {
            return;
        }

        const input = form.querySelector('input[name="quantity"]');
        if (!input) {
            return;
        }

        const current = parseInt(input.value || '1', 10) || 1;
        input.value = minus ? Math.max(1, current - 1) : current + 1;
    });

    grid.querySelectorAll('form[data-cart-form]').forEach(function (form) {
        form.addEventListener('submit', async function (event) {
            event.preventDefault();

            const button = form.querySelector('.add-to-cart-btn');
            if (!button) {
                form.submit();
                return;
            }

            const originalText = button.innerHTML;
            const originalStyle = button.getAttribute('style');

            button.innerHTML = '? Agregando...';
            button.style.opacity = '0.7';
            button.disabled = true;

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                document.dispatchEvent(new CustomEvent('cartUpdated'));

                button.innerHTML = '? ?Agregado!';
                button.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
            } catch (error) {
                console.error('Error al agregar al carrito:', error);
                button.innerHTML = '? Error';
                button.style.background = 'var(--accent-danger)';
            } finally {
                setTimeout(function () {
                    button.innerHTML = originalText;
                    button.style.opacity = '1';
                    button.disabled = false;

                    if (originalStyle) {
                        button.setAttribute('style', originalStyle);
                    } else {
                        button.style.removeProperty('background');
                    }
                }, 1500);
            }
        });
    });
});
</script>
{% endblock %}
