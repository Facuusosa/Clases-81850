{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block title %}Catálogo de Sahumerios - Fuego de Atenea{% endblock %}
{% block body_class %}page-catalog{% endblock %}

{% block styles %}
<style>
/* Use site mystic theme variables for consistency */
:root {
    --bg-primary: var(--mystic-cream);
    --bg-secondary: rgba(255,255,255,0.7);
    --bg-card: rgba(255,255,255,0.9);
    --bg-card-hover: rgba(255,255,255,1);
    --text-primary: var(--mystic-text);
    --text-secondary: color-mix(in srgb, var(--mystic-text) 80%, black 0%);
    --text-muted: rgba(61,55,49,0.7);
    --accent: var(--mystic-gold);
    --accent-hover: var(--mystic-gold-light);
    --border: rgba(201, 169, 97, 0.25);
    --border-hover: rgba(201, 169, 97, 0.45);
    --shadow-sm: 0 2px 8px rgba(201, 169, 97, 0.12);
    --shadow-md: 0 6px 18px rgba(201, 169, 97, 0.18);
    --shadow-lg: 0 10px 36px rgba(201, 169, 97, 0.22);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
.page-catalog { background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }

/* Typography */
.catalog-header { text-align: center; margin: 0 auto 48px; max-width: 880px; padding: 24px; }
.catalog-title { font-size: clamp(2rem, 5vw, 3rem); font-weight: 400; color: var(--accent); margin-bottom: 12px; letter-spacing: -0.02em; }
.catalog-subtitle { font-size: 1rem; font-weight: 300; color: var(--text-secondary); letter-spacing: 0.01em; }

/* Buttons (scoped) */
.page-catalog .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 24px; font-size:.9rem; font-weight:500; text-decoration:none; border:1px solid var(--border); border-radius:8px; background:transparent; color:var(--text-primary); cursor:pointer; transition:all .2s ease; letter-spacing:.02em; }
.page-catalog .btn:hover { background:var(--bg-card); border-color:var(--accent); color:var(--accent); }
.page-catalog .btn-primary { background:var(--accent); color:#fff; border-color:var(--accent); }
.page-catalog .btn-primary:hover { background:var(--accent-hover); border-color:var(--accent-hover); color:#fff; box-shadow:0 6px 16px rgba(201,169,97,.28); }
.page-catalog .btn-danger { border-color:#d4756a; color:#d4756a; }
.page-catalog .btn-danger:hover { background:#d4756a; color:#fff; }

/* Grid */
.products-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 28px; padding: 0 8px; max-width: 1400px; margin: 0 auto; }

/* Product Cards */
.product-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; transition: all .25s ease; position: relative; overflow: hidden; display:flex; flex-direction:column; }
.product-card:hover { border-color: var(--accent); box-shadow: var(--shadow-md); transform: translateY(-2px); }

/* Badges */
.product-badges { position:absolute; top:12px; left:12px; z-index:2; display:flex; flex-direction:column; gap:8px; }
.badge { padding: 6px 12px; font-size: .7rem; font-weight: 500; text-transform: uppercase; letter-spacing: .08em; background: rgba(255,255,255,.95); color: var(--text-primary); border: 1px solid var(--border); backdrop-filter: blur(8px); border-radius: 4px; }
.badge-best-seller { background: var(--accent); color: #fff; border-color: var(--accent); }
.badge-new { background: rgba(255,255,255,.95); color: var(--accent); border-color: var(--accent); }
.badge-import { background: rgba(255,255,255,.95); color: var(--text-secondary); border-color: var(--border-hover); }

/* Image */
.product-image { position: relative; height: 300px; background: var(--bg-secondary); overflow: hidden; display:flex; align-items:center; justify-content:center; border-bottom:1px solid var(--border); }
.product-image img { width: 100%; height: 100%; object-fit: contain; padding: 28px; transition: transform .35s ease, opacity .25s ease; }
.product-card:hover .product-image img { transform: scale(1.03); }

/* Actions */
.product-actions { position:absolute; top:12px; right:12px; display:flex; flex-direction:column; gap:8px; opacity:0; transform: translateX(8px); transition: all .25s ease; }
.product-card:hover .product-actions { opacity:1; transform: translateX(0); }
.action-btn { width:38px; height:38px; border:1px solid var(--border); background: rgba(255,255,255,.95); color: var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all .2s ease; backdrop-filter: blur(8px); border-radius: 6px; }
.action-btn:hover { background: var(--bg-card-hover); border-color: var(--accent); }

/* Info */
.product-info { padding: 18px; flex-grow: 1; display:flex; flex-direction:column; }
.product-title { font-size: 1.05rem; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; letter-spacing: -0.01em; }
.product-title a { color: inherit; text-decoration: none; }
.product-title a:hover { color: var(--accent); }
.product-brand { font-size:.8rem; color: var(--text-muted); margin-bottom: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: .05em; }
.product-description { font-size:.9rem; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient: vertical; }

/* Price */
.product-price { display:flex; align-items:baseline; gap: 12px; margin-top:auto; padding-top: 12px; border-top:1px solid var(--border); margin-bottom: 12px; }
.current-price { font-size: 1.4rem; font-weight: 700; color: var(--accent); letter-spacing: -0.02em; }
.old-price { font-size: .9rem; color: var(--text-muted); text-decoration: line-through; }
.discount-badge { font-size: .75rem; color: var(--text-secondary); font-weight: 600; letter-spacing: .02em; }

/* Quantity */
.quantity-selector { display:flex; align-items:center; gap:0; margin-bottom: 12px; border:1px solid var(--border); width:fit-content; border-radius:6px; overflow:hidden; }
.qty-btn { width:36px; height:36px; border:none; background: transparent; color: var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all .2s ease; font-size: 1rem; }
.qty-btn:hover { background: var(--bg-card-hover); color: var(--accent-hover); }
.qty-btn:first-child { border-right:1px solid var(--border); }
.qty-btn:last-child { border-left:1px solid var(--border); }
.qty-input { width: 52px; height:36px; border:none; background:transparent; color: var(--text-primary); text-align:center; font-weight:600; font-size:.95rem; }
.qty-input:focus { outline:none; }

/* Edit Mode */
.edit-mode-banner { background: var(--bg-card); border:1px solid var(--border); padding: 18px; margin: 0 8px 28px; max-width: 1400px; margin-left:auto; margin-right:auto; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap: 12px; border-radius: 10px; }
.edit-actions { display:flex; gap: 10px; flex-wrap: wrap; }

/* Forms */
.cart-form { display:flex; flex-direction:column; }
.add-to-cart-btn { width: 100%; }

/* Responsive */
@media (max-width: 768px) {
  .products-grid { grid-template-columns: 1fr; gap: 20px; padding: 0; }
  .catalog-header { padding: 20px; margin-bottom: 36px; }
  .product-image { height: 240px; }
  .edit-mode-banner { flex-direction: column; align-items: flex-start; }
  .edit-actions { width: 100%; }
  .edit-actions .btn { flex: 1; }
}

@media (max-width: 480px) {
  .product-image { height: 220px; }
  .product-info { padding: 16px; }
}
</style>
{% endblock %}

{% block content %}
<div class="catalog-header">
    <h1 class="catalog-title">Colección de Sahumerios</h1>
    <p class="catalog-subtitle">Fragancias artesanales y ediciones especiales</p>
  </div>

  {% if edit_mode %}
  <div class="edit-mode-banner">
    <div>
      <strong>Modo edición activado</strong>
      <p style="margin:4px 0 0; font-size:.9rem; color: var(--text-secondary);">Podés agregar, editar o eliminar productos</p>
    </div>
    <div class="edit-actions">
      <a href="{% url 'sahumerios_lista' %}" class="btn">Salir</a>
      <a href="{% url 'sahumerio_nuevo' %}" class="btn btn-primary">Crear producto</a>
    </div>
  </div>
  {% endif %}

  <div class="products-grid">
    {% for it in items %}
      {% with target_url=it.pk|default:it.idx %}
      <article class="product-card" data-product-id="{{ target_url }}" data-product-origin="{{ it.origen }}">
        {% if it.origen == 'DB' and it.pk %}
          {% url 'sahumerio_detalle' it.pk as detail_url %}
        {% elif it.match_id %}
          {% url 'sahumerio_detalle' it.match_id as detail_url %}
        {% else %}
          {% url 'excel_detalle' it.idx as detail_url %}
        {% endif %}

        <div class="product-badges">
          {% if forloop.counter <= 3 %}
          <span class="badge badge-best-seller">Favorito</span>
          {% endif %}

          {% if not it.match_id %}
            {% if it.origen != 'DB' or not it.pk %}
          <span class="badge badge-import">Destacado</span>
            {% endif %}
          {% endif %}

          {% if forloop.counter|divisibleby:5 %}
          <span class="badge badge-new">Nuevo</span>
          {% endif %}
        </div>

        <div class="product-image">
          <a href="{{ detail_url }}">
            {% with img_src=it.img_abs|default:it.img_file %}
              {% if img_src %}
                {% if it.img_file and not it.img_abs %}
                  <img src="{% static 'img/productos/' %}{{ img_src }}" alt="{{ it.titulo }}" loading="lazy" decoding="async">
                {% else %}
                  <img src="{{ img_src }}" alt="{{ it.titulo }}" loading="lazy" decoding="async">
                {% endif %}
              {% else %}
                <img src="{% static 'img/placeholder.png' %}" alt="Sin imagen" loading="lazy" decoding="async">
              {% endif %}
            {% endwith %}
          </a>

          <div class="product-actions">
            <button class="action-btn" type="button" title="Vista rápida">👁️</button>
            <button class="action-btn" type="button" title="Favorito">❤</button>
          </div>
        </div>

        <div class="product-info">
          <h3 class="product-title">
            <a href="{{ detail_url }}">{{ it.titulo }}</a>
          </h3>

          {% if it.marca %}
          <p class="product-brand">{{ it.marca }}</p>
          {% endif %}

          {% if it.descripcion %}
          <p class="product-description">{{ it.descripcion }}</p>
          {% endif %}

          <div class="product-price">
            <span class="current-price">$ {{ it.precio|floatformat:2|intcomma }}</span>
            {% if forloop.counter|divisibleby:4 %}
            <span class="old-price">$ {{ it.precio|add:500|floatformat:2|intcomma }}</span>
            <span class="discount-badge">-15%</span>
            {% endif %}
          </div>

          {% if edit_mode %}
          <div class="edit-actions" style="margin-bottom: 12px;">
            {% if it.origen == 'DB' and it.pk %}
              <a href="{% url 'sahumerio_editar' it.pk %}?volver={{ request.get_full_path|urlencode }}" class="btn">Editar</a>
              <form method="post" action="{% url 'sahumerio_borrar' it.pk %}" onsubmit="return confirm('¿Borrar este producto?')" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Borrar</button>
              </form>
            {% else %}
              <a href="{% url 'sahumerio_nuevo' %}?sug_marca={{ it.marca|urlencode }}&sug_nombre={{ it.titulo|urlencode }}&sug_descripcion={{ it.descripcion|urlencode }}&sug_precio={{ it.precio|urlencode }}&sug_imagen_url={{ it.img_abs|urlencode }}&sug_imagen_file={{ it.img_file|urlencode }}" class="btn btn-primary">Crear en DB</a>
            {% endif %}
          </div>
          {% endif %}

          {% if it.origen == 'DB' and it.pk %}
            {% with item_id=it.pk %}
            <form action="{% url 'cart:add_db' item_id %}" method="post" class="cart-form" data-cart-form data-product-id="{{ item_id }}">
              {% csrf_token %}
              <input type="hidden" name="replace" value="0">
              <div class="quantity-selector">
                <button type="button" class="qty-btn qty-minus">−</button>
                <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                <button type="button" class="qty-btn qty-plus">+</button>
              </div>
              <button type="submit" class="btn btn-primary add-to-cart-btn">Agregar al carrito</button>
            </form>
            {% endwith %}
          {% elif it.match_id %}
            {% with item_id=it.match_id %}
            <form action="{% url 'cart:add_db' item_id %}" method="post" class="cart-form" data-cart-form data-product-id="{{ item_id }}">
              {% csrf_token %}
              <input type="hidden" name="replace" value="0">
              <div class="quantity-selector">
                <button type="button" class="qty-btn qty-minus">−</button>
                <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                <button type="button" class="qty-btn qty-plus">+</button>
              </div>
              <button type="submit" class="btn btn-primary add-to-cart-btn">Agregar al carrito</button>
            </form>
            {% endwith %}
          {% else %}
            <form action="{% url 'cart:add' %}" method="post" class="cart-form" data-cart-form>
              {% csrf_token %}
              <input type="hidden" name="origin" value="X">
              <input type="hidden" name="product_id" value="{{ it.idx }}">
              <input type="hidden" name="name" value="{{ it.titulo }}">
              <input type="hidden" name="price" value="{{ it.precio }}">
              <input type="hidden" name="img" value="{% if it.img_abs %}{{ it.img_abs }}{% elif it.img_file %}{% static 'img/productos/' %}{{ it.img_file }}{% else %}{% static 'img/placeholder.png' %}{% endif %}">
              <input type="hidden" name="replace" value="0">
              <div class="quantity-selector">
                <button type="button" class="qty-btn qty-minus">−</button>
                <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                <button type="button" class="qty-btn qty-plus">+</button>
              </div>
              <button type="submit" class="btn add-to-cart-btn">Agregar material</button>
            </form>
          {% endif %}
        </div>
      </article>
      {% endwith %}
    {% empty %}
      <p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">{% trans "No hay sahumerios disponibles" %}</p>
    {% endfor %}
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const grid = document.querySelector('.products-grid');
    if (!grid) return;

    grid.addEventListener('click', function (event) {
      const minus = event.target.closest('.qty-minus');
      const plus = event.target.closest('.qty-plus');
      if (!minus && !plus) return;

      const form = event.target.closest('form');
      if (!form) return;

      const input = form.querySelector('input[name="quantity"]');
      if (!input) return;

      const current = parseInt(input.value || '1', 10) || 1;
      input.value = minus ? Math.max(1, current - 1) : current + 1;
    });

    grid.querySelectorAll('form[data-cart-form]').forEach(function (form) {
      form.addEventListener('submit', async function (event) {
        event.preventDefault();

        const button = form.querySelector('.add-to-cart-btn');
        if (!button) { form.submit(); return; }

        const originalText = button.innerHTML;
        button.innerHTML = 'Agregando...';
        button.style.opacity = '0.6';
        button.disabled = true;

        try {
          const response = await fetch(form.action, { method: 'POST', body: new FormData(form), headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!response.ok) throw new Error('HTTP ' + response.status);
          document.dispatchEvent(new CustomEvent('cartUpdated'));
          button.innerHTML = 'Agregado';
        } catch (error) {
          console.error('Error:', error);
          button.innerHTML = 'Error';
        } finally {
          setTimeout(function () { button.innerHTML = originalText; button.style.opacity = '1'; button.disabled = false; }, 1500);
        }
      });
    });
  });
  </script>
{% endblock %}

