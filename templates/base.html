{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Fuego de Atenea{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ csrf_token }}">
  {% block meta %}{% endblock %}

  <link rel="icon" href="{% static 'img/fuegodeatenealogo.png' %}">
  <link href="{% static 'css/styles.css' %}?v=3" rel="stylesheet">

  <style>
    :root{--bg:#f7f8fb;--text:#1a1a1a;--muted:#6b7280;--brand:#111827;--card:#ffffff;--b:#e5e7eb;--shadow:0 1px 6px rgba(0,0,0,.05);--btn:#111827;--btnText:#fff;--btnDanger:#dc2626;--btnSec:#374151;--cart-active:#10b981}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";color:var(--text);background:var(--bg)}
    a{text-decoration:none;color:inherit}
    .wrap{max-width:1150px;margin:0 auto;padding:0 22px}
    .topbar{background:var(--brand);color:#fff;position:sticky;top:0;z-index:10}
    .topbar .wrap{padding:12px 22px}
    .topbar nav{display:flex;gap:16px;align-items:center}
    .topbar nav a{color:#e5e7eb;opacity:.9}
    .topbar nav a:hover{opacity:1}
    .topbar nav a[aria-current="page"]{color:#fff;font-weight:700;text-decoration:underline}
    main.wrap{padding:26px 22px 40px}
    h1,h2,h3{margin:0 0 .6rem 0}
    h2{font-size:1.6rem}
    .btn{display:inline-block;background:var(--btn);color:var(--btnText);border:1px solid #0000;border-radius:10px;padding:8px 14px;font-weight:600;line-height:1;cursor:pointer;transition:.15s box-shadow,.15s transform,.15s background}
    .btn:hover{box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .btn-sec{background:var(--btnSec);color:#fff}
    .btn-danger{background:var(--btnDanger);color:#fff}
    .card{background:var(--card);border:1px solid var(--b);border-radius:14px;box-shadow:var(--shadow)}
    .msg{background:#eef6ff}
    .msg.error{background:#fee2e2}
    footer.wrap{color:var(--muted)}
    .lb{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:1000}
    .lb.show{display:flex}
    .lb img{max-width:90vw;max-height:90vh;transform-origin:0 0;cursor:grab;touch-action:none}
    .lb .close{position:absolute;top:14px;right:14px;background:#000;border:0;color:#fff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    [data-zoom-src]{cursor:zoom-in}
    .zoomable::after{content:none!important;display:none!important}
    
    /* NUEVOS ESTILOS MEJORADOS PARA EL CARRITO */
    .cart-widget{position:relative;display:inline-block}
    .btn-cart-toggle{background:none;border:none;color:inherit;cursor:pointer;display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;transition:all 0.3s ease}
    .btn-cart-toggle:hover{background:rgba(255,255,255,0.1);transform:translateY(-1px)}
    .btn-cart-toggle.cart-active{background:var(--cart-active);color:white;box-shadow:0 2px 8px rgba(16, 185, 129, 0.3)}
    .cart-badge{background:#ef4444;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;animation:pulse 2s infinite}
    .cart-dropdown{display:none;position:absolute;right:0;top:100%;background:white;border:1px solid #ddd;border-radius:12px;padding:16px;min-width:350px;box-shadow:0 8px 25px rgba(0,0,0,0.15);z-index:1000;margin-top:8px;color:#1a1a1a}
    .cart-dropdown.show{display:block;animation:slideDown 0.3s ease}
    .cart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #f0f0f0}
    .cart-title{font-weight:700;font-size:18px;color:#111827;margin:0}
    .cart-count{background:#111827;color:white;border-radius:12px;padding:4px 10px;font-size:12px;font-weight:600}
    .cart-item{display:flex;justify-content:space-between;align-items:flex-start;padding:12px 0;border-bottom:1px solid #f8f8f8}
    .cart-item:last-child{border-bottom:none}
    .cart-item-info{flex:1;min-width:0}
    .cart-item-name{font-weight:600;margin:0 0 6px 0;color:#111827;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cart-item-meta{font-size:14px;color:#6b7280;margin:0;display:flex;gap:8px;align-items:center}
    .cart-item-total{font-weight:700;color:#111827;font-size:15px;min-width:80px;text-align:right}
    .cart-empty{text-align:center;padding:30px 20px;color:#6b7280}
    .cart-empty-icon{font-size:48px;margin-bottom:12px;opacity:0.5}
    .cart-total{display:flex;justify-content:space-between;align-items:center;border-top:2px solid #eee;padding-top:16px;margin-top:16px;font-weight:700;font-size:18px;color:#111827}
    .cart-actions{display:flex;gap:10px;margin-top:16px}
    .cart-actions .btn{flex:1;text-align:center;padding:10px 16px;font-weight:600}
    
    /* Animaciones */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Mejoras para productos en el dropdown */
    .product-highlight{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600}
    
    @media (max-width:720px){
      .topbar .wrap{padding:10px 16px} 
      main.wrap{padding:20px 16px 28px}
      .cart-dropdown{position:fixed;left:16px;right:16px;top:80px;min-width:auto;max-width:none}
      .cart-item-name{font-size:14px}
      .cart-item-meta{font-size:13px}
    }
  </style>

  {% block styles %}{% endblock %}
</head>
<body>
  <header class="topbar">
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
      <a href="{% url 'landing' %}" style="display:flex;align-items:center;gap:8px;color:#fff">
        <img src="{% static 'img/fuegodeatenealogo.png' %}" alt="Fuego de Atenea" style="height:28px">
        <strong>Fuego de Atenea</strong>
      </a>

      {% with current=request.resolver_match.url_name|default:'' edit=request.GET.modo|default:'' %}
      <nav style="display:flex;align-items:center;gap:16px">
        <a href="{% url 'sahumerios_lista' %}"
           {% if current == 'sahumerios_lista' and edit != 'edit' %}aria-current="page"{% endif %}>
           Sahumerios
        </a>

        {% if user.is_authenticated and user.username|lower == 'fsosa' %}
          <a href="{% url 'sahumerios_lista' %}?modo=edit"
             {% if current == 'sahumerios_lista' and edit == 'edit' %}
               aria-current="page"
             {% elif current == 'sahumerio_nuevo' or current == 'sahumerio_editar' %}
               aria-current="page"
             {% endif %}>
             Agregar/editar material
          </a>
          <a href="/admin/" target="_blank" rel="noopener noreferrer">Admin</a>
        {% endif %}

        <!-- WIDGET DEL CARRITO MEJORADO -->
        <div class="cart-widget">
          <button class="btn-cart-toggle {% if current == 'cart:detail' or current == 'cart:checkout_form' %}cart-active{% endif %}" 
                  id="cartToggle">
            üõí Carrito
            {% if cart_len > 0 %}
            <span class="cart-badge" id="cartBadge">{{ cart_len }}</span>
            {% endif %}
          </button>
          
          <div class="cart-dropdown" id="cartDropdown">
            <div class="cart-header">
              <h3 class="cart-title">Tu Carrito</h3>
              {% if cart_len > 0 %}
              <span class="cart-count">{{ cart_len }} √≠tem{{ cart_len|pluralize:"s" }}</span>
              {% endif %}
            </div>
            
            <div class="cart-items" id="cartItems">
              {% if cart_len > 0 %}
                <div style="max-height:280px;overflow-y:auto;" id="cartItemsList">
                  {% for item in cart_items %}
                  <div class="cart-item">
                    <div class="cart-item-info">
                      <div class="cart-item-name" title="{{ item.name }}">
                        {{ item.name|truncatechars:35 }}
                        {% if forloop.first and cart_len > 3 %}
                        <span class="product-highlight">Nuevo</span>
                        {% endif %}
                      </div>
                      <div class="cart-item-meta">
                        <span>{{ item.quantity }} √ó ${{ item.price }}</span>
                        <span style="color:#10b981;font-weight:600;">‚Ä¢</span>
                        <span style="font-weight:500;">Subtotal: ${{ item.subtotal }}</span>
                      </div>
                    </div>
                    <div class="cart-item-total">${{ item.subtotal }}</div>
                  </div>
                  {% endfor %}
                  
                  {% if cart_len > 3 %}
                  <div style="text-align:center;padding:8px;color:#6b7280;font-size:14px;">
                    + {{ cart_len|add:"-3" }} producto{{ cart_len|add:"-3"|pluralize:"s" }} m√°s en el carrito
                  </div>
                  {% endif %}
                </div>
                
                <div class="cart-total">
                  <span>Total:</span>
                  <span style="color:#10b981;font-size:20px;">${{ cart_total }}</span>
                </div>
                
                <div class="cart-actions">
                  <a href="{% url 'cart:detail' %}" class="btn" style="flex:2;background:#111827;">
                    üìã Ver carrito completo
                  </a>
                  <a href="{% url 'cart:checkout_form' %}" class="btn" style="flex:1;background:#10b981;">
                    üõçÔ∏è Comprar
                  </a>
                </div>
              {% else %}
                <div class="cart-empty">
                  <div class="cart-empty-icon">üõí</div>
                  <p style="margin:0 0 16px 0;font-size:16px;">Tu carrito est√° vac√≠o</p>
                  <a href="{% url 'sahumerios_lista' %}" class="btn" style="background:#111827;">
                    Descubrir productos
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        {% if user.is_authenticated %}
          <a href="{% url 'perfil' %}" {% if current == 'perfil' %}aria-current="page"{% endif %}>Perfil ({{ user.username }})</a>
          <a href="{% url 'logout' %}">Salir</a>
        {% else %}
          <a href="{% url 'login' %}" {% if current == 'login' %}aria-current="page"{% endif %}>Ingresar</a>
          <a href="{% url 'registro' %}" {% if current == 'registro' %}aria-current="page"{% endif %}>Registrarme</a>
        {% endif %}
      </nav>
      {% endwith %}
    </div>
  </header>

  <main class="wrap">
    {% if messages %}
      <div class="messages" aria-live="polite" role="region">
        {% for message in messages %}
          <div class="msg {{ message.tags }}" role="alert" style="padding:10px 12px;border-radius:10px;margin:12px 0">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

  <footer class="wrap" style="padding:24px 0;text-align:center">
    <small>&copy; {% now "Y" %} Fuego de Atenea ¬∑ <a href="https://www.instagram.com/fuego.de.atenea" target="_blank" rel="noopener">@fuego.de.atenea</a></small>
  </footer>

  <div class="lb" id="lightbox">
    <button class="close" id="lbClose">Cerrar</button>
    <img id="lbImg" src="" alt="">
  </div>

  <script>
    window.CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]')?.content;
    
    // CARRITO DROPDOWN MEJORADO
    document.addEventListener('DOMContentLoaded', function() {
      const cartToggle = document.getElementById('cartToggle');
      const cartDropdown = document.getElementById('cartDropdown');
      
      if (cartToggle && cartDropdown) {
        cartToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          cartDropdown.classList.toggle('show');
          
          // Resaltar el bot√≥n cuando el dropdown est√° abierto
          if (cartDropdown.classList.contains('show')) {
            cartToggle.classList.add('cart-active');
          } else {
            // Solo quitar el resaltado si no estamos en una p√°gina del carrito
            const isCartPage = window.location.pathname.includes('/cart/');
            if (!isCartPage) {
              cartToggle.classList.remove('cart-active');
            }
          }
        });
        
        // Cerrar al hacer click fuera
        document.addEventListener('click', function(e) {
          if (!cartDropdown.contains(e.target) && e.target !== cartToggle) {
            cartDropdown.classList.remove('show');
            const isCartPage = window.location.pathname.includes('/cart/');
            if (!isCartPage) {
              cartToggle.classList.remove('cart-active');
            }
          }
        });
        
        // Verificar si estamos en una p√°gina del carrito al cargar
        const isCartPage = window.location.pathname.includes('/cart/');
        if (isCartPage) {
          cartToggle.classList.add('cart-active');
        }
      }
      
      // Actualizar carrito autom√°ticamente cuando se agregan productos
      function updateCartBadge() {
        fetch('/cart/summary/')
          .then(response => response.json())
          .then(data => {
            const badge = document.getElementById('cartBadge');
            if (data.total_items > 0) {
              if (!badge) {
                const newBadge = document.createElement('span');
                newBadge.className = 'cart-badge';
                newBadge.id = 'cartBadge';
                newBadge.textContent = data.total_items;
                document.getElementById('cartToggle').appendChild(newBadge);
                
                // Animaci√≥n cuando se agrega un producto nuevo
                newBadge.style.animation = 'pulse 0.5s ease 3';
              } else {
                badge.textContent = data.total_items;
                // Animaci√≥n cuando se actualiza la cantidad
                badge.style.animation = 'none';
                setTimeout(() => {
                  badge.style.animation = 'pulse 0.5s ease 2';
                }, 10);
              }
            } else if (badge) {
              badge.remove();
            }
          })
          .catch(error => console.log('Error actualizando carrito:', error));
      }
      
      // Escuchar eventos de actualizaci√≥n del carrito
      document.addEventListener('cartUpdated', updateCartBadge);
    });

    // LIGHTBOX (existente)
    (function(){
      const lb=document.getElementById('lightbox');
      const img=document.getElementById('lbImg');
      const btn=document.getElementById('lbClose');

      let scale=1, tx=0, ty=0, dragging=false, sx=0, sy=0;

      function open(src){
        scale=1;tx=0;ty=0;
        img.style.transform='translate(0,0) scale(1)';
        img.src=src;
        lb.classList.add('show');
      }
      function close(){lb.classList.remove('show'); img.src=''}
      function apply(){img.style.transform=`translate(${tx}px,${ty}px) scale(${scale})`}

      img.addEventListener('pointerdown',e=>{dragging=true;img.setPointerCapture(e.pointerId);sx=e.clientX;sy=e.clientY;img.style.cursor='grabbing'});
      img.addEventListener('pointermove',e=>{if(!dragging)return;tx+=e.clientX-sx;ty+=e.clientY-sy;sx=e.clientX;sy=e.clientY;apply()});
      img.addEventListener('pointerup',()=>{dragging=false;img.style.cursor='grab'});
      img.addEventListener('wheel',e=>{
        e.preventDefault();
        const f=e.deltaY<0?1.1:0.9;
        const ns=Math.min(6,Math.max(1,scale*f));
        const rect=img.getBoundingClientRect();
        const cx=e.clientX-rect.left;
        const cy=e.clientY-rect.top;
        const k=ns/scale;
        tx=cx-(cx-tx)*k; ty=cy-(cy-ty)*k;
        scale=ns; apply();
      },{passive:false});

      lb.addEventListener('click',e=>{if(e.target===lb) close()});
      btn.addEventListener('click',close);
      document.addEventListener('keydown',e=>{if(e.key==='Escape') close()});

      document.addEventListener('click',e=>{
        const el=e.target.closest('[data-zoom-src]');
        if(!el) return;
        e.preventDefault();
        open(el.getAttribute('data-zoom-src'));
      });
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>